let currentMarker = null; // 현재 표시된 마커를 저장하는 변수

// 뒤로 가기 버튼 기능
function goBack() {
    window.history.back();
}

// 사용자가 로그인하면 로그아웃 버튼으로 전환
function checkLoginStatus() {
    const isLoggedIn = false; // 실제 로그인 상태 체크 로직을 여기에 구현해야 합니다.

    if (isLoggedIn) {
        const loginNavItem = document.querySelector('a[href="login.html"]');
        loginNavItem.href = "index.html"; // 로그아웃 시 메인 페이지로 이동
        loginNavItem.innerHTML = '<img src="images/logout.png" alt="로그아웃" style="height: 30px;">';
        loginNavItem.onclick = function() {
            alert('로그아웃 되었습니다.');
            // 로그아웃 로직을 여기에 추가하세요.
        };
    }
}

// 구글 맵 초기화 함수
function initMap() {
    const map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 37.5665, lng: 126.9780 }, // 서울의 기본 좌표
        zoom: 12
    });

    // 클릭 이벤트 추가
    map.addListener('click', function(event) {
        placeMarkerAndPanTo(event.latLng, map);
    });
}

// 마커를 배치하고 해당 위치의 날씨 정보를 가져오는 함수
function placeMarkerAndPanTo(latLng, map) {
    // 기존 마커가 있으면 제거
    if (currentMarker) {
        currentMarker.setMap(null);
    }

    // 새로운 마커 생성
    currentMarker = new google.maps.Marker({
        position: latLng,
        map: map
    });

    map.panTo(latLng);

    // 클릭한 위치의 날씨 정보를 가져와서 표시
    fetchWeatherByCoordinates(latLng.lat(), latLng.lng());
}

// 좌표를 사용해 날씨 정보를 가져오는 함수
function fetchWeatherByCoordinates(lat, lon) {
    const apiKey = "5233d140772d45ceb3ec91756afa4e78"; // Weatherbit API 키
    const url = `https://api.weatherbit.io/v2.0/current?lat=${lat}&lon=${lon}&key=${apiKey}&lang=ko`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            const weatherData = `
                <strong>${data.data[0].city_name}</strong>의 현재 날씨: 
                ${data.data[0].weather.description}, 온도: ${data.data[0].temp}°C
            `;
            document.getElementById("weather-data").innerHTML = weatherData;
        })
        .catch(error => {
            console.error("Error fetching the weather data:", error);
            document.getElementById("weather-data").innerHTML = error.message;
        });
}

// 페이지 로드 시 모든 초기화 작업을 수행합니다.
function initPage() {
    checkLoginStatus();
    initMap(); // 구글 맵 초기화
}
